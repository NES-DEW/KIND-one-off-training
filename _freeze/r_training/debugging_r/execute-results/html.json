{
  "hash": "51275c34f5a68709c421be6147c25918",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Debugging R\ndate: 2024-09-05\nexecute: \n  echo: true\n  eval: true\n  output: true\n  freeze: auto\ncategories: [R, beginner, troubleshooting]\neditor_options: \n  chunk_output_type: console\n---\n\n\n## Debugging R\n\n![My sequence of R errors while writing this training session. These pages are published via a GitHub action which can be a bit complex to troubleshoot. I'm definitely still a beginner at that](images/clipboard-3516250507.png){height=\"300\"}\n\n-   R code often misbehaves\n    -   that's true of code in general - it's not specific to R\n-   learning to manage errors and problems effectively is a long-term learning issue\n    -   most programmers, no matter their level of expertise, spent much of their time fixing problems\n- this session is designed to give you a basic toolkit of strategies for dealing with broken code\n\n## Session outline\n- Avoiding errors\n- Types of broken code\n- Pin-pointing problems\n- Isolating errors\n- Finding help\n- Fancier stuff\n\n::: {.callout-note}\nThis advice assumes you're using Rstudio / Posit to edit and run your R code\nMost of the troubleshooting advice is fairly general, and should apply to anything\nThat's not true in the broken code section\n:::\n\n## Avoiding errors\n\nThe best kind of troubleshooting is no troubleshooting. You can avoid errors by:\n\n+ planning carefully before writing proper code - I write the script in comments first, then translate into code. This has the useful side-effect of annotating the code for no extra effort\n+ working in a logical sequence from start to finish\n+ keeping code simple and legible. That means short scripts with `source()`, and using functions and functional programming to avoid repetitious code\n+ avoiding creating loads of variables (do a lot of things directly if you don't need the data for later), and careful variable naming\n+ refactoring messy code at the time to keep it clean\n+ keeping code formatted nicely\n\nI see a lot of broken code, and the commonest cause by far is excessive script length and complexity. Learning to write functions is the single greatest thing you can do to make your code simpler and thus avoid bugs.\n\n## How is your code broken?\n\n### My code won't run at all\nThis is the commonest, hard-to-solve error that most of us encounter. It usually means that there's some problem recognizing the R code you're looking at as being R code. It's hard to solve because you don't have a nice informative error message (or anything else) to look at. Things to check at this point are:\n\n::: {.callout-tip}\n\n### A list of generic R troubleshooting strategies\n1. make sure the last line of the console has a `>` rather than a `+`. If you see `+`, R is waiting for you to do something. Press `Esc` a couple of times, then try your code again\n1. try running some new code in the console (`2 + 2` if more than enough)\n1. restart R (`Ctrl` + `Shift` + `F10`)\n1. terminate R (`Session` menu)\n1. close and reopen Rstudio (or hard-refresh `Ctrl`+`F5` the page for Posit)\n1. make sure the code you're trying to run is saved as an .R file\n1. if you're on the desktop, make sure you have [R installed on your machine](https://a-little-book-of-r-for-time-series.readthedocs.io/en/latest/src/installr.html) \n1. try opening a different project and seeing if that code will run\n:::\n\n### I'm getting an error message\nMost R error messages tell you what's wrong by providing an error message in the console. In fact, many R functions will also tell you what's gone right there too. The term of art here is that R code is generally *surly* - it complains a lot, even when things are going right. Here, we're going to ignore those informative messages, and concentrate on proper errors that prevent your code from running properly. \n\n### My output is wonky\nThe opposite problem: your code seems to run perfectly, but you don't get the output you're expecting. Given that you don't have an error message to work from, you'll need to try and work backwards from the output you're expecting. But a few examples of output that's gone wrong:\n\n- numeric values are bigger/smaller than expected\n- text is incorrect, poorly-formatted, squishedtogether, or IN THE WRONG CASE\n- graphs miss values or mis-represent values\n- the possibilities are endless\n\nIn general, finding and fixing output problems is a manual business. You should expect to have output errors in new code, and it's important to allow yourself time and space to both check for errors, and to resolve them.\n\n## Pin-pointing problems\n\nTo solve an error you'll almost always need to refine your understanding of a) what's gone wrong, and b) where it's gone wrong. \n\n### Read the error message\n\nObvious but takes practice. Most R error messages give you clues as to how to find and fix the problem. The key here is that a) the message will contain the work `Error` and b) your code will stop running. Many errors from more recent packages have nice explanations and fixes. In general, the older the function, the more difficult the error. That wasn't always the case, and some older R functions have horrid error messages. Here's a short dictionary for some classics:\n\n+ `could not find function ‘thing’` = you've mis-spelled a function name or failed to load a package\n+ `there is no package called ‘glok’` = you've mis-spelled a package name - or you haven't installed it\n+ `object 'mpg' not found` = you haven't created an object, or you've missed a pipe somewhere\n+ `non-numeric argument to binary operator` = you've tried to do maths with words somewhere\n+ `longer object length is not a multiple of shorter object length` or `length of 'dimnames' [2] not equal to array extent` = [you've fallen into vector recycling rules](https://eriqande.github.io/rep-res-web/lectures/vectorization_recycling_and_indexing.html)\n+ lots of weird errors about `filter` - make sure you're using `dplyr::filter` specifically\n\n### Finding errors\nUnlike many programming languages, R doesn't give you a line number for errors. It is [possible, but a bit messy](https://stackoverflow.com/questions/1445964/how-to-get-r-script-line-numbers-at-error), to add line numbers, but might be worth it if you're coming from Python or similar. You can usually see the malfunctioning line of code immediately above the error message in the console.\n\nIf your error message isn't that helpful, you can try running the `traceback()` command in the console, which will show you the series of steps that led to your last error. The trick here is to read bottom-to-top: the top of the `traceback()` output was the last function that ran before R fell over.\n\nYou can also, if you're getting desperate, try some old-fashioned print debugging, by putting some `print(\"some label\")` statements into your code. They'll appear in the console, so you might be able to detect the location of your error if all else fails. But really, if you're at this point you should probably move onto a more involved strategy...\n\n### Check the basic stuff\n\nIf that hasn't worked, we're into debugging proper. So, at this point, make sure that you've restart R to clean up your environment, run your code again, and then looked carefully at your output/error message to decide what's wrong with it. At this point, I'd also try to write the problem down, which is an effective but irrational strategy that often seems to yield results.\n\nAssuming that fails, we can run through a set of quick checks that are always worth trying:\n\n::: {.callout-tip}\n### A list of basic code errors\n\n1. check your brackets - `Code` > `Rainbow parentheses` (or *rainbow brackets* for those of us in British-inflected English) are fantastic for this\n1. look for easy transpositions like `<` / `>`, `+` / `-`\n1. check that your function names are correct, and you're not accidentally using false-friends (`class()` and `typeof()` are really nice examples)\n      1. a quick check of each function's help at this point, just to check it really does what you think it does, is highly recommended\n1. ensure all your packages are installed and loaded. If in doubt, use namespacing `package::function`\n1. make sure that you're actually looking at this code's output, and haven't accidentally calculated something without showing it...\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresult <- 1+5+8+9\nprint(results) # slightly different variable name\n```\n:::\n\n\n:::\n\n## Isolating errors\nIf you can't find your problem fairly easily, then you need to cut your code down to size to make your search easier.\n\n### Make a minimal example\nThe best advice for tricky problems is to make your problem as specific as problem. That means removing any irrelevant code. We'll call this the minimal example. Assuming that you've already tried the sequence of basic troubleshooting steps above, you'd go about it as follows:\n\n1. **switch off** any unnecessary parts of your code to pin down where the error is happening\n    1. you can do that by adding `#` or `Ctrl`+`Shift`+`c`\n    1. or, **probably cognitively better**, copy the misbehaving code to a new script\n1. try to run that extracted piece of code (again, probably after restarting R)\n    1. you'll almost certainly need to load packages, and add other pieces of code to get it to run\n    1. whatever you do, do the minimum. No loading all the usual packages, no copy-pasting great gobbets of code around the place, just try and keep the script as simple as possible\n1. when you've got the code to run, you'll either:\n    1. have the same error again, in which case you're in a much better position to do the same thing again to localise the error within that new, simpler, script you've just built\n    1. have fixed the error, in which case you now know what you need to look elsewhere in your original code for the source of the problem\n    1., given yourself a brand-new error to focus on. Lucky you! Definitely try to fix that new error before proceeding\n\nIf that doesn't work, it's time to look up the chain to the inputs of this piece of code. I'd work as follows:\n\n1. check for types - so if you're expecting your code to add numbers together, ensure that your inputs are both numbers\n1. check that the variable names line up\n1. check that there's no other code that could potentially alter any of your inputs\n1. finally, repeat the isolation exercise above for each input\n\n### Reprex\n\n= **repr**oducible **ex**ample. See the [documentation for the reprex package](https://reprex.tidyverse.org/), especially the [helpful set of do's and don't](https://reprex.tidyverse.org/articles/reprex-dos-and-donts.html).\n\nIf the minimal example method above doesn't find your problem, you're probably going to need to ask for help. Luckily, the preparatory work you'll need for that is directly helpful in solving your problem.\n\nGenerally, when people want to help you with your R code, the first thing they'll want to do is to run it A reprex is a way of packaging up everything your code needs so that anyone can copy and paste it. This is important, because a bare snippet of code doesn't tell the full story. For example, say this bit of code isn't working for me:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_data |>\n  filter(flavours = \"chocolate\") |>\n  transmogrify() \n```\n:::\n\n\nA potential ally and helper won't be able to assist me with this as it stands. They won't know about my data, they won't know which packages I'm using, and (last line) they won't even recognize the function name that I just made up. To save a lot of annoying back and forth, you should turn this into a minimal example (see above), and then use reprex to help your helpers. I need at least the following bits to make this code reproducible:\n\n+ the data\n+ an idea of where `filter()` comes from\n+ a definition of `transmogrify()`\n\nThat breaks down as follows:\n\n+ provide a short snippet of data\n+ include any relevant package loading\n+ include the function definition for any non-package functions\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\n\nmy_data <- tibble(flavours = c(\"chocolate\", \"onion\", \"chocolate\"),\n                  scoop_size = c(100,120,100),\n                  count = c(200,500,400))\n\ntransmogrify <- function(df){\n  df |>\n    dplyr::summarise(total_vol_l = sum(scoop_size * count)/1000)\n}\n\nmy_data |>\n  dplyr::filter(flavours = \"chocolate\") |> # I can now run this and find the error!\n  transmogrify() \n```\n:::\n\n\n> This usually means that you've used `=` instead of `==`.\n\nGetting data together for a reprex is the most painful bit, particularly if you're dealing with something real-world and lengthy. I like the [datapasta](https://milesmcbain.github.io/datapasta/) package for this, as it has the useful function `tribble_format` that will take some data and turn it into a copy/pastable format that you can use in a reprex.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndatapasta::tribble_format(head(mtcars, 4))\n```\n:::\n\n\n\n## Finding help\n\nYou should definitely read the incredibly short (+ free) chapter in [R for Data Science](https://r4ds.hadley.nz/workflow-help) as a start. R is a widely-used language, which means that most errors will have cropped-up in some form before. In general, I'd suggest a thorough search for your term before asking for specific help. Some search tips:\n\n+ look in the help before anything online\n+ be specific - mention package/function names and error messages. Often including the whole error message in quotes can sharpen things up a bit\n+ include \"R\" in your search string to ensure you're getting relevant results\n+ you might also use the \"site: stackoverflow.com\" to restrict searches to one of the most useful and relevant sources there is\n\nOtherwise, assuming this fails, you should ask for help. I'd probably think about one of three venues for that:\n\n- if you're reading this, you already know about the KIND network. We have a large R community - come and chat!\n- if you're NHS, the NHSR community is great and full of experts. They have an active Slack channel\n- otherwise, the big player is stackoverflow. They can be fierce, but definitely some serious experts out there\n\nWherever you ask for help, please help yourself:\n+ be sure you know about any local rules governing asking for help\n+ search carefully to make sure you're not the twentieth person this week asking the same question\n+ a specific, but concise, question is the thing. Include the error message, give basic details about your setup (R 4.4.1, Rstudio, Windows, e.g) and **include your reprex** so that potential helpers don't have to ask you for it\n    \n## Fancier stuff\nAs you write more complex code, I would want to add two more sets of tools. The first of these is `browser()`/breakpoints. These are mainly used to understand what's going on inside functions. I'd recommend [the chapter in Advanced R as an entry point](https://adv-r.hadley.nz/debugging.html) to these techniques.\n\nThe other strategy is to formalize and automate your testing. Again, well beyond the scope of this beginner's session, but if you're interested in this powerful approach for more advanced applications you can review our [unit testing materials](https://nes-dew.github.io/KIND-training/r_training/testing.html) for an accessible introduction.\n  - unit testing",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}